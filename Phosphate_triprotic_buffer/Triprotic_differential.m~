% Obtained form the webpage: http://www.chemicalforums.com/index.php?topic=80995.0
% Takes 151 sec to complete on 8 cores, 8 GB memory Dell machine

clear
clc
tic

Rate_const_no=10;
Diffeq_no=8;

%Numerical integration
Custom_RelTol=1e-10;
Custom_AbsTol=1e-18;
Max_time=1e18; %sec

% Equilibrium constants
KW = power(10,-14);
K1 = power(10,-2.15);		%power(10,-3.08);
K2 = power(10,-6.86); 		%power(10,-4.74);
K3 = power(10,-12.32); 		%power(10,-5.4);


% Initial concentration of acid
C_acid = 1; % mol/dm^3
C_base = 1; % 1.0

% Initial volume of acid
Acid_vol = 877; % ml
Base_vol = 123; % ml



% Graph settings
Titration_resolution=500; % number of titration points
dx = Base_vol/(Titration_resolution-1);
x = 0.0:dx:Base_vol;


% Array for all the species
H3A=size(Titration_resolution,1);
H2A=size(Titration_resolution,1);
HA=size(Titration_resolution,1);
A=size(Titration_resolution,1);
NaH2=size(Titration_resolution,1);
Na2H=size(Titration_resolution,1);
H=size(Titration_resolution,1);
PH=size(Titration_resolution,1);
NaOH=size(Titration_resolution,1);
OH=size(Titration_resolution,1);
FNa2H=size(Titration_resolution,1);	% Dibasic
FNaH2=size(Titration_resolution,1);	% Monobasic


% Volume and Beta
NaH2_vol=size(Titration_resolution,1);
Na2H_vol=size(Titration_resolution,1);
Tot_vol=size(Titration_resolution,1);
Beta=size(Titration_resolution,1);



K=size(Rate_const_no);
Y_init=size(Titration_resolution,1);
Y_tol=size(Diffeq_no);

for i = 1:Diffeq_no
Y_tol(i)=Custom_AbsTol;
end

outfile=fopen('Results','w');

fprintf(outfile,'NaH2_vol(i,1) Na2H_vol(i,1) Tot_vol(i,1) H3A(i,1) H2A(i,1) HA(i,1) A(i,1) NaH2(i,1) Na2H(i,1) H(i,1)  OH(i,1) PH(i,1) FNaH2(i,1) FNa2H(i,1) Beta(i,1)\n');


for i = 1:Titration_resolution

	% The total volume
	vol_tot = Acid_vol + x(i);

	% Concentrations of acid and base
	C_a0 = (C_acid * Acid_vol) / vol_tot;
	C_b0 = (C_base * x(i)) / vol_tot ;

	NaH2_vol(i,1)=Acid_vol;
	Na2H_vol(i,1)=x(i);
	Tot_vol(i,1)=vol_tot;

	% Compute the concentration of hydrogen ions

		Y_init(1)=0;
		Y_init(2)=0;
		Y_init(3)=0;
		Y_init(4)=0;
		Y_init(5)=C_a0;
		Y_init(6)=C_b0;
		Y_init(7)=power(10,-7);
		Y_init(8)=power(10,-7);


		FNaH2(i,1)=C_a0;
		FNa2H(i,1)=C_b0;



		options = odeset('RelTol',Custom_RelTol,'AbsTol',Y_tol);

		K(1)=K1;		%1.7378*power(10,-5);
		K(2)=power(10,0);
		K(3)=K2;		%6.3*power(10,-1);
		K(4)=power(10,0);	%1.7378*power(10,-5);
		K(5)=K3;		%6.3*power(10,-1);
		K(6)=power(10,0);	%1.7378*power(10,-5);
		K(7)=power(10,2);
		K(8)=power(10,2);
		K(9)=power(10,-14);
		K(10)=power(10,0);


	[T,Y] = ode15s(@Triprotic_ODE,[0,Max_time],Y_init,options,K);

	S=size(Y);


	% Calculate all other species
	H3A(i,1) = Y(S(1),1);
	H2A(i,1) = Y(S(1),2);
	HA(i,1) = Y(S(1),3);
	A(i,1) = Y(S(1),4);
	NaH2(i,1) = Y(S(1),5);
	Na2H(i,1) = Y(S(1),6);
	H(i,1) = Y(S(1),7);
	OH(i,1) = Y(S(1),8);


	% Calculate the pH value
	PH(i,1) = -log10(H(i,1));



	if(i>1)
	Beta(i,1)=(FNa2H(i,1)-FNa2H(i-1,1))/(PH(i,1)-PH(i-1,1));
	else 
	Beta(i,1)=0;
	end

	fprintf(outfile,'%.12f %.12f %.12f %.12f %.12f %.12f %.12f %.12f %.12f %.20f %.20f %.12f %.12f %.12f %.12f\n',NaH2_vol(i,1), Na2H_vol(i,1), Tot_vol(i,1), H3A(i,1),H2A(i,1),HA(i,1),A(i,1),NaH2(i,1),Na2H(i,1),H(i,1), OH(i,1), PH(i,1),FNaH2(i,1),FNa2H(i,1),Beta(i,1));


	
	i
end



fclose(outfile);


% Plot it
figure();
plot(x,PH,'red')
xlabel('Volume Alkali (ml)')
ylabel('pH')
title('Titration (Volume of alkali vs pH)')
toc
